<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Group 4 - During Flood Scenario</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Group 4</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./overview.html" rel="" target="">
 <span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./proposal.html" rel="" target="">
 <span class="menu-text">Proposal</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-methodology" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Methodology</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-methodology">    
        <li>
    <a class="dropdown-item" href="./dataprep.html" rel="" target="">
 <span class="dropdown-text">Data Preparation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./before.html" rel="" target="">
 <span class="dropdown-text">Before Flood Scenario</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./during.html" rel="" target="">
 <span class="dropdown-text">During Flood Scenario</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./after.html" rel="" target="">
 <span class="dropdown-text">After Flood Scenario</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./resupply.html" rel="" target="">
 <span class="dropdown-text">Resupply to Shelters and Hospitals</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./results.html" rel="" target="">
 <span class="menu-text">Results and Discussion</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./lessons.html" rel="" target="">
 <span class="menu-text">Lessons Learnt</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setting-the-scene" id="toc-setting-the-scene" class="nav-link active" data-scroll-target="#setting-the-scene">Setting the Scene</a></li>
  <li><a href="#clipping-roads-outside-of-flood-extent" id="toc-clipping-roads-outside-of-flood-extent" class="nav-link" data-scroll-target="#clipping-roads-outside-of-flood-extent">Clipping Roads outside of Flood Extent</a></li>
  <li><a href="#converting-flood-extent-polygon-to-a-line-layer" id="toc-converting-flood-extent-polygon-to-a-line-layer" class="nav-link" data-scroll-target="#converting-flood-extent-polygon-to-a-line-layer">Converting Flood Extent Polygon to a Line layer</a></li>
  <li><a href="#creating-startpoints-at-flood-extent-layer-with-intersection" id="toc-creating-startpoints-at-flood-extent-layer-with-intersection" class="nav-link" data-scroll-target="#creating-startpoints-at-flood-extent-layer-with-intersection">Creating StartPoints at flood extent layer with Intersection</a></li>
  <li><a href="#cleaning-intersection-points" id="toc-cleaning-intersection-points" class="nav-link" data-scroll-target="#cleaning-intersection-points">Cleaning Intersection Points</a></li>
  <li><a href="#od-matrix-for-shelters" id="toc-od-matrix-for-shelters" class="nav-link" data-scroll-target="#od-matrix-for-shelters">OD Matrix for Shelters</a></li>
  <li><a href="#finding-shortest-paths-to-shelters" id="toc-finding-shortest-paths-to-shelters" class="nav-link" data-scroll-target="#finding-shortest-paths-to-shelters">Finding Shortest Paths to Shelters</a></li>
  <li><a href="#creating-centroids-for-hospitals" id="toc-creating-centroids-for-hospitals" class="nav-link" data-scroll-target="#creating-centroids-for-hospitals">Creating Centroids for Hospitals</a></li>
  <li><a href="#od-matrix-and-shortest-paths-for-hospitals" id="toc-od-matrix-and-shortest-paths-for-hospitals" class="nav-link" data-scroll-target="#od-matrix-and-shortest-paths-for-hospitals">OD Matrix and Shortest Paths for Hospitals</a></li>
  <li><a href="#data-cleaning-of-startpoints" id="toc-data-cleaning-of-startpoints" class="nav-link" data-scroll-target="#data-cleaning-of-startpoints">Data Cleaning of Startpoints</a></li>
  <li><a href="#mapping" id="toc-mapping" class="nav-link" data-scroll-target="#mapping">Mapping</a></li>
  <li><a href="#medical-accessibility-from-shelters-and-flood-extent" id="toc-medical-accessibility-from-shelters-and-flood-extent" class="nav-link" data-scroll-target="#medical-accessibility-from-shelters-and-flood-extent">Medical Accessibility from Shelters and Flood Extent</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">During Flood Scenario</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="setting-the-scene" class="level1">
<h1>Setting the Scene</h1>
<p>For the During Flood scenario, we decided to use the points which the perimeter of the flood extent (flood extent outline) intersects with the roads as origin points where people can evacuate from the flood. This is because the road network within the flood area would be destroyed and flooded, and therefore unable to be used for evacuation.</p>
<p>Thus in this scenario, we assumed that remaining survivors of the flood would be able to escape to the edge of the flood extent and use the undestroyed road networks outside of the damaged area to evacuate to shelters and hospitals. Using the Roads data from Copernicus ESMR, we were thus able to ascertain which roads outside the flood extent could be used, which was all of them as the destroyed and damaged roads were mostly within the flood extent.</p>
<p><img src="images/image115.jpg" class="img-fluid"></p>
</section>
<section id="clipping-roads-outside-of-flood-extent" class="level1">
<h1>Clipping Roads outside of Flood Extent</h1>
<p>From menu bar, select Vector → Geoprocessing Tools → Difference</p>
<p><img src="images/image33.jpg" class="img-fluid"></p>
<p>Difference dialogue window appears.&nbsp;</p>
<ul>
<li><p>Under Input layer, select emsr_roads (the GRA version)</p></li>
<li><p>For Overlay layer, select flood_extent</p></li>
<li><p>Click on Run.</p></li>
</ul>
<p><img src="images/image64-01.jpg" class="img-fluid"></p>
<p>Map window should now look like this with a temporary Difference layer created. Save this layer into Geopackage, naming it emsr_roads_outside_flood.</p>
<p><img src="images/image72.jpg" class="img-fluid"></p>
</section>
<section id="converting-flood-extent-polygon-to-a-line-layer" class="level1">
<h1>Converting Flood Extent Polygon to a Line layer</h1>
<p>From the menu bar, select Processing → Toolbox.</p>
<ul>
<li><p>Type ‘polygon to lines’ in the search bar</p></li>
<li><p>Select Polygons to lines under Vector geometry</p></li>
</ul>
<p><img src="images/image160.jpg" class="img-fluid"></p>
<p>Polygons to lines dialogue window appears.</p>
<p><img src="images/image118.jpg" class="img-fluid"></p>
<ul>
<li><p>Under Input layer, select flood_extent</p></li>
<li><p>Click on Run when ready for operation to run.</p></li>
</ul>
<p>A temporary Line output layer will be created. Save this layer into Geopackage and name the layer as flood_extent_line.</p>
</section>
<section id="creating-startpoints-at-flood-extent-layer-with-intersection" class="level1">
<h1>Creating StartPoints at flood extent layer with Intersection</h1>
<p>From Toolbox, type in ‘line intersections’ in search bar.</p>
<p><img src="images/image30.jpg" class="img-fluid"></p>
<p>Select Line intersections under Vector overlay.</p>
<p>Line Intersections dialogue window appears.&nbsp;</p>
<ul>
<li><p>Under Input layer, select flood_extent_line</p></li>
<li><p>Under Intersect layer, select emsr_roads</p></li>
</ul>
<p><img src="images/image148.jpg" class="img-fluid"></p>
<p>A temporary output layer named Intersections should be added into the map window.&nbsp;</p>
<p><img src="images/image105.jpg" class="img-fluid"></p>
</section>
<section id="cleaning-intersection-points" class="level1">
<h1>Cleaning Intersection Points</h1>
<p>Before saving the layer into Geopackage, we need to first check that the intersection points are valid to be considered as Startpoints where people can evacuate from the flood.</p>
<p><img src="images/image13.jpg" class="img-fluid"></p>
<p><img src="images/image3.jpg" class="img-fluid"></p>
<p>Zoom into the Intersections layer and use Toggle Editing and Select Features to remove points which are connected to broken roads or roads that only lead to another intersection point.</p>
<p><img src="images/image66.jpg" class="img-fluid"></p>
<p><img src="images/image141.jpg" class="img-fluid"></p>
<ul>
<li>After selecting the points that are unsuitable to be startpoints, click on the Trash icon in the Toggle Editing bar and delete the selected features.</li>
</ul>
<p><img src="images/image107.jpg" class="img-fluid"></p>
<p><img src="images/image11.jpg" class="img-fluid"></p>
<p>After deleting all unsuitable points, save the temporary layer into Geopackage, name the layer as ‘startpoints’.</p>
</section>
<section id="od-matrix-for-shelters" class="level1">
<h1>OD Matrix for Shelters</h1>
<p>Now we want to origin-destination pairs from startpoints to shelters outside the flood extent. The shelters outside of the flood extent have been clipped and the layer is named suitable_shelters.</p>
<p><img src="images/image140.jpg" class="img-fluid"></p>
<p>From Processing → Toolbox → type ‘od matrix’.</p>
<ul>
<li>Select OD Matrix from Layers as Lines (m:n) under Distance Matrices in the QNEAT3 plugin.</li>
</ul>
<p><img src="images/image90.jpg" class="img-fluid"></p>
<p>The OD Matrix from Layers as Lines dialogue window appears.&nbsp;</p>
<ul>
<li><p>For Network Layer, select emsr_roads_outside_flood.</p></li>
<li><p>For From-Point Layer, select startpoints.</p></li>
<li><p>For To-Point Layer, select suitable_shleters.&nbsp;</p></li>
<li><p>Select Shortest Path (distance optimization) for Optimization Criterion</p></li>
<li><p>Under Advanced Parameters, select Matrix geometry follow routes for Generated Matrix Geometry style</p></li>
</ul>
<p><img src="images/image106.jpg" class="img-fluid"></p>
<p><img src="images/image138.jpg" class="img-fluid"></p>
<ul>
<li>Click on Run once ready</li>
</ul>
<p>Map window should look like this with the Output OD Matrix generated.</p>
<p><img src="images/image101.jpg" class="img-fluid"></p>
<p>Save the output layer into Geopackage, naming it ‘during_OD_matrix’.</p>
<p><img src="images/image98.jpg" class="img-fluid"></p>
</section>
<section id="finding-shortest-paths-to-shelters" class="level1">
<h1>Finding Shortest Paths to Shelters</h1>
<p>From menu bar, select Database → DB Manager</p>
<ul>
<li><p>Select Output_OD_matrix layer from Virtual layer</p></li>
<li><p>Add Query layer and type in the following query:</p></li>
</ul>
<p><img src="images/image164.jpg" class="img-fluid"></p>
<ul>
<li>Click on Execute</li>
</ul>
<p><img src="images/image130.jpg" class="img-fluid"></p>
<ul>
<li><p>Click on Load as new layer</p></li>
<li><p>Select geometry from Geometry column</p></li>
<li><p>Click on Load</p></li>
</ul>
<p>Map window should now look like this with the QueryLayer added, showing the shortest paths from startpoints to shelters.</p>
<p><img src="images/image43.jpg" class="img-fluid"></p>
<p>Exported querylayer as shortest_paths. [later renamed as shortest_paths (shelters)].</p>
<p><img src="images/image38.jpg" class="img-fluid"></p>
</section>
<section id="creating-centroids-for-hospitals" class="level1">
<h1>Creating Centroids for Hospitals</h1>
<p>From menu bar, select Vector → Geometry Tools → Centroids</p>
<p><img src="images/image8.jpg" class="img-fluid"></p>
<p>Centroids dialogue window appears.</p>
<ul>
<li>Under Input layer, select Hospitals layer</li>
</ul>
<p><img src="images/image10.jpg" class="img-fluid"></p>
<ul>
<li>Click on Run</li>
</ul>
<p>Map window should look like this with temporary output layer Centroids created.</p>
<p><img src="images/image51.jpg" class="img-fluid"></p>
<p>From the menu bar, click on Select Features.</p>
<p><img src="images/image21.jpg" class="img-fluid"></p>
<p>Select the hospital centroids outside the flood extent and extract them into a new layer, suitable_hospitals.</p>
<p><img src="images/image57.jpg" class="img-fluid"></p>
<p><img src="images/image9.jpg" class="img-fluid"></p>
</section>
<section id="od-matrix-and-shortest-paths-for-hospitals" class="level1">
<h1>OD Matrix and Shortest Paths for Hospitals</h1>
<p>Repeat the steps above to create an OD Matrix from startpoints to suitable_hospitals, with parameters as shown below.</p>
<p><img src="images/image156.jpg" class="img-fluid"></p>
<p>Repeat the steps above, using DB Manager to create a QueryLayer that computes the shortest paths from startpoints to hospitals using the OD Matrix.</p>
<p><img src="images/image117-01.jpg" class="img-fluid"></p>
<p>After loading the query, a new QueryLayer should be created into QGIS.&nbsp;</p>
</section>
<section id="data-cleaning-of-startpoints" class="level1">
<h1>Data Cleaning of Startpoints</h1>
<p>Upon examination of the Realising that some of the startpoints do not have routes to hospitals. Checking both OD matrix attribute tables, selected their Origin IDs and by observation found out that the roads they are connected to are broken. Thus, we removed them from the original startpoints layer.&nbsp;</p>
<ul>
<li>From startpoints layer, open Attribute Table → Select by Expression → selected fids that were not suitable startpoints</li>
</ul>
<p><img src="images/image163.jpg" class="img-fluid"></p>
<ul>
<li>Click on Toggle Editing → Delete features</li>
</ul>
<p><img src="images/image89.jpg" class="img-fluid"></p>
<p><img src="images/image73.jpg" class="img-fluid"></p>
<ul>
<li>Repeat the data cleaning steps for other necessary layers like the OD matrices and QueryLayers.&nbsp;&nbsp;</li>
</ul>
<p>Save the most recent temporary QueryLayer into Geopackage and name the layer as shortest_paths (hospitals).&nbsp;</p>
<p>Map window should now look like this.</p>
<p><img src="images/image139.jpg" class="img-fluid"></p>
</section>
<section id="mapping" class="level1">
<h1>Mapping</h1>
<p>Follow similar steps from the Before Flood scenario to create these maps, one showing the routes and shortest paths to shelters, the other showing the same but to hospitals outside the flood extent.&nbsp;</p>
<ul>
<li><p>Steps for Legend (as the legend for During and After were created in QGIS)</p>
<ul>
<li><p>Set the title as ‘Legend’.</p></li>
<li><p>Check ‘only show items inside linked map’</p></li>
<li><p>Under Font and text formatting, set the legend title font to Georgia, 16 points.</p></li>
<li><p>Under Font and text formatting, set the labels font to Georgia, 14 points.</p></li>
</ul></li>
</ul>
<p><img src="images/image36.png" class="img-fluid"></p>
<p><img src="images/image47-01.png" class="img-fluid"></p>
</section>
<section id="medical-accessibility-from-shelters-and-flood-extent" class="level1">
<h1>Medical Accessibility from Shelters and Flood Extent</h1>
<p>Setting OSM road Speeds</p>
<ul>
<li><p>Open the attribute table of the OSM roads (23 oct) layer outside of the flood extent (OSM_roads_outside_flood)</p></li>
<li><p>Open Field Calculator</p></li>
<li><p>Create a new Integer field called Speed using the following expression:</p></li>
</ul>
<p><strong>CASE</strong></p>
<p><strong>WHEN “fclass” = ‘primary’ then 50</strong></p>
<p><strong>WHEN “fclass” = ‘primary_link’ then 50</strong></p>
<p><strong>WHEN “fclass” = ‘residential’ then 50</strong></p>
<p><strong>WHEN “fclass” = ‘secondary’&nbsp; then 50</strong></p>
<p><strong>WHEN “fclass” = ‘secondary_link’ then 50</strong></p>
<p><strong>WHEN “fclass” = ‘service’ then 15</strong></p>
<p><strong>WHEN “fclass” = ‘tertiary’&nbsp; then 50</strong></p>
<p><strong>WHEN “fclass” = ‘tertiary_link’ then 50</strong></p>
<p><strong>WHEN “fclass” = ‘trunk’ then 50</strong></p>
<p><strong>WHEN “fclass” =&nbsp; ‘trunk_link’ then 50</strong></p>
<p><strong>WHEN “fclass” =&nbsp; ‘unclassified’ then 15</strong></p>
<p><strong>ELSE 5</strong></p>
<p><strong>END</strong></p>
<ul>
<li><p>Click ‘OK’</p></li>
<li><p>Untoggle editing mode using the pencil icon and save the changes.</p></li>
<li><p>Close the attribute table</p></li>
</ul>
<p>OD Matrix</p>
<ul>
<li><p>From processing tools, search for OD Matrix from Layers as Lines (M:N).</p></li>
<li><p>Set the following parameters: OSM_roads_outside_flood as the Network layer, suitable_shelters as the From-Point Layer, Hospitals as To-Point layer, Fastest Path as Optimization Criterion, Matrix Geometry follows routes as Generated Matrix geometry style, oneway as Direction field with the direction values F,T,B in that order. Speed as speed field and default speed as 5km/h.</p></li>
</ul>
<p><img src="images/image122.png" class="img-fluid"></p>
<ul>
<li><p>Rename the output layer accordingly, ensuring there is no spaces. E.g. ODmatrix_time_shelterToHospital_osmOutsideFlood</p></li>
<li><p>Open Database -&gt; DB Manager, then navigate to the output layer.</p></li>
<li><p>Input the SQL code:</p></li>
</ul>
<p><strong>select origin_id, destination_id, min(total_cost) as shortest_path, geometry</strong></p>
<p><strong>from ODmatrix_time_shelterToHospital_osmOutsideFlood</strong></p>
<p><strong>group by origin_id</strong></p>
<ul>
<li>Check ‘Load as new layer’, input a layer name, check ‘Geometry column’ as geometry, then click ‘Load’.</li>
</ul>
<p><img src="images/image54.png" class="img-fluid"></p>
<ul>
<li><p>Save the output into the geopackage.</p></li>
<li><p>Repeat using the flood extent startpoints as the From-Point layer.</p></li>
</ul>
<p><img src="images/image46.png" class="img-fluid"></p>
<p><img src="images/image150.png" class="img-fluid"></p>
<ul>
<li>Follow similar steps from the previous scenarios to create maps for these 2 layers. For example,</li>
</ul>
<p><img src="images/image16-01.png" class="img-fluid"></p>
<p>We are now finished with the preparation of the during scenario maps and analysis.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>